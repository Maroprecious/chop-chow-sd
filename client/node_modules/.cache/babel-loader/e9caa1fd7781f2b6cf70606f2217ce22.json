{"ast":null,"code":"import { __assign, __awaiter, __generator } from \"tslib\";\nimport { HttpRequest } from \"@aws-sdk/protocol-http\";\nimport { getChecksumAlgorithmForRequest } from \"./getChecksumAlgorithmForRequest\";\nimport { getChecksumLocationName } from \"./getChecksumLocationName\";\nimport { hasHeader } from \"./hasHeader\";\nimport { isStreaming } from \"./isStreaming\";\nimport { selectChecksumAlgorithmFunction } from \"./selectChecksumAlgorithmFunction\";\nimport { stringHasher } from \"./stringHasher\";\nimport { validateChecksumFromResponse } from \"./validateChecksumFromResponse\";\nexport var flexibleChecksumsMiddleware = function flexibleChecksumsMiddleware(config, middlewareConfig) {\n  return function (next) {\n    return function (args) {\n      return __awaiter(void 0, void 0, void 0, function () {\n        var request, requestBody, headers, base64Encoder, streamHasher, input, requestChecksumRequired, requestAlgorithmMember, checksumAlgorithm, updatedBody, updatedHeaders, checksumLocationName, checksumAlgorithmFn, getAwsChunkedEncodingStream, bodyLengthChecker, rawChecksum, result, requestValidationModeMember, responseAlgorithms;\n\n        var _a;\n\n        return __generator(this, function (_b) {\n          switch (_b.label) {\n            case 0:\n              if (!HttpRequest.isInstance(args.request)) {\n                return [2, next(args)];\n              }\n\n              request = args.request;\n              requestBody = request.body, headers = request.headers;\n              base64Encoder = config.base64Encoder, streamHasher = config.streamHasher;\n              input = middlewareConfig.input, requestChecksumRequired = middlewareConfig.requestChecksumRequired, requestAlgorithmMember = middlewareConfig.requestAlgorithmMember;\n              checksumAlgorithm = getChecksumAlgorithmForRequest(input, {\n                requestChecksumRequired: requestChecksumRequired,\n                requestAlgorithmMember: requestAlgorithmMember\n              });\n              updatedBody = requestBody;\n              updatedHeaders = headers;\n              if (!checksumAlgorithm) return [3, 3];\n              checksumLocationName = getChecksumLocationName(checksumAlgorithm);\n              checksumAlgorithmFn = selectChecksumAlgorithmFunction(checksumAlgorithm, config);\n              if (!isStreaming(requestBody)) return [3, 1];\n              getAwsChunkedEncodingStream = config.getAwsChunkedEncodingStream, bodyLengthChecker = config.bodyLengthChecker;\n              updatedBody = getAwsChunkedEncodingStream(requestBody, {\n                base64Encoder: base64Encoder,\n                bodyLengthChecker: bodyLengthChecker,\n                checksumLocationName: checksumLocationName,\n                checksumAlgorithmFn: checksumAlgorithmFn,\n                streamHasher: streamHasher\n              });\n              updatedHeaders = __assign(__assign({}, headers), {\n                \"content-encoding\": \"aws-chunked\",\n                \"transfer-encoding\": \"chunked\",\n                \"x-amz-decoded-content-length\": headers[\"content-length\"],\n                \"x-amz-content-sha256\": \"STREAMING-UNSIGNED-PAYLOAD-TRAILER\",\n                \"x-amz-trailer\": checksumLocationName\n              });\n              delete updatedHeaders[\"content-length\"];\n              return [3, 3];\n\n            case 1:\n              if (!!hasHeader(checksumLocationName, headers)) return [3, 3];\n              return [4, stringHasher(checksumAlgorithmFn, requestBody)];\n\n            case 2:\n              rawChecksum = _b.sent();\n              updatedHeaders = __assign(__assign({}, headers), (_a = {}, _a[checksumLocationName] = base64Encoder(rawChecksum), _a));\n              _b.label = 3;\n\n            case 3:\n              return [4, next(__assign(__assign({}, args), {\n                request: __assign(__assign({}, request), {\n                  headers: updatedHeaders,\n                  body: updatedBody\n                })\n              }))];\n\n            case 4:\n              result = _b.sent();\n              requestValidationModeMember = middlewareConfig.requestValidationModeMember, responseAlgorithms = middlewareConfig.responseAlgorithms;\n\n              if (requestValidationModeMember && input[requestValidationModeMember] === \"ENABLED\") {\n                validateChecksumFromResponse(result.response, {\n                  config: config,\n                  responseAlgorithms: responseAlgorithms\n                });\n              }\n\n              return [2, result];\n          }\n        });\n      });\n    };\n  };\n};","map":{"version":3,"sources":["/home/chuka/joe/ChopChowSD/node_modules/@aws-sdk/middleware-flexible-checksums/dist-es/flexibleChecksumsMiddleware.js"],"names":["__assign","__awaiter","__generator","HttpRequest","getChecksumAlgorithmForRequest","getChecksumLocationName","hasHeader","isStreaming","selectChecksumAlgorithmFunction","stringHasher","validateChecksumFromResponse","flexibleChecksumsMiddleware","config","middlewareConfig","next","args","request","requestBody","headers","base64Encoder","streamHasher","input","requestChecksumRequired","requestAlgorithmMember","checksumAlgorithm","updatedBody","updatedHeaders","checksumLocationName","checksumAlgorithmFn","getAwsChunkedEncodingStream","bodyLengthChecker","rawChecksum","result","requestValidationModeMember","responseAlgorithms","_a","_b","label","isInstance","body","sent","response"],"mappings":"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","sourcesContent":["import { __assign, __awaiter, __generator } from \"tslib\";\nimport { HttpRequest } from \"@aws-sdk/protocol-http\";\nimport { getChecksumAlgorithmForRequest } from \"./getChecksumAlgorithmForRequest\";\nimport { getChecksumLocationName } from \"./getChecksumLocationName\";\nimport { hasHeader } from \"./hasHeader\";\nimport { isStreaming } from \"./isStreaming\";\nimport { selectChecksumAlgorithmFunction } from \"./selectChecksumAlgorithmFunction\";\nimport { stringHasher } from \"./stringHasher\";\nimport { validateChecksumFromResponse } from \"./validateChecksumFromResponse\";\nexport var flexibleChecksumsMiddleware = function (config, middlewareConfig) {\n    return function (next) {\n        return function (args) { return __awaiter(void 0, void 0, void 0, function () {\n            var request, requestBody, headers, base64Encoder, streamHasher, input, requestChecksumRequired, requestAlgorithmMember, checksumAlgorithm, updatedBody, updatedHeaders, checksumLocationName, checksumAlgorithmFn, getAwsChunkedEncodingStream, bodyLengthChecker, rawChecksum, result, requestValidationModeMember, responseAlgorithms;\n            var _a;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        if (!HttpRequest.isInstance(args.request)) {\n                            return [2, next(args)];\n                        }\n                        request = args.request;\n                        requestBody = request.body, headers = request.headers;\n                        base64Encoder = config.base64Encoder, streamHasher = config.streamHasher;\n                        input = middlewareConfig.input, requestChecksumRequired = middlewareConfig.requestChecksumRequired, requestAlgorithmMember = middlewareConfig.requestAlgorithmMember;\n                        checksumAlgorithm = getChecksumAlgorithmForRequest(input, {\n                            requestChecksumRequired: requestChecksumRequired,\n                            requestAlgorithmMember: requestAlgorithmMember,\n                        });\n                        updatedBody = requestBody;\n                        updatedHeaders = headers;\n                        if (!checksumAlgorithm) return [3, 3];\n                        checksumLocationName = getChecksumLocationName(checksumAlgorithm);\n                        checksumAlgorithmFn = selectChecksumAlgorithmFunction(checksumAlgorithm, config);\n                        if (!isStreaming(requestBody)) return [3, 1];\n                        getAwsChunkedEncodingStream = config.getAwsChunkedEncodingStream, bodyLengthChecker = config.bodyLengthChecker;\n                        updatedBody = getAwsChunkedEncodingStream(requestBody, {\n                            base64Encoder: base64Encoder,\n                            bodyLengthChecker: bodyLengthChecker,\n                            checksumLocationName: checksumLocationName,\n                            checksumAlgorithmFn: checksumAlgorithmFn,\n                            streamHasher: streamHasher,\n                        });\n                        updatedHeaders = __assign(__assign({}, headers), { \"content-encoding\": \"aws-chunked\", \"transfer-encoding\": \"chunked\", \"x-amz-decoded-content-length\": headers[\"content-length\"], \"x-amz-content-sha256\": \"STREAMING-UNSIGNED-PAYLOAD-TRAILER\", \"x-amz-trailer\": checksumLocationName });\n                        delete updatedHeaders[\"content-length\"];\n                        return [3, 3];\n                    case 1:\n                        if (!!hasHeader(checksumLocationName, headers)) return [3, 3];\n                        return [4, stringHasher(checksumAlgorithmFn, requestBody)];\n                    case 2:\n                        rawChecksum = _b.sent();\n                        updatedHeaders = __assign(__assign({}, headers), (_a = {}, _a[checksumLocationName] = base64Encoder(rawChecksum), _a));\n                        _b.label = 3;\n                    case 3: return [4, next(__assign(__assign({}, args), { request: __assign(__assign({}, request), { headers: updatedHeaders, body: updatedBody }) }))];\n                    case 4:\n                        result = _b.sent();\n                        requestValidationModeMember = middlewareConfig.requestValidationModeMember, responseAlgorithms = middlewareConfig.responseAlgorithms;\n                        if (requestValidationModeMember && input[requestValidationModeMember] === \"ENABLED\") {\n                            validateChecksumFromResponse(result.response, {\n                                config: config,\n                                responseAlgorithms: responseAlgorithms,\n                            });\n                        }\n                        return [2, result];\n                }\n            });\n        }); };\n    };\n};\n"]},"metadata":{},"sourceType":"module"}